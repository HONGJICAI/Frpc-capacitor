name: Build

on:
  push:
    branches:
      - master
  pull_request:
    branches:
      - master
  workflow_dispatch:
  workflow_call:

env:
  FRP_VERSION: "0.66.0"

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: my-app/package-lock.json

      - name: Install npm dependencies
        working-directory: my-app
        run: npm ci

      - name: Download frpc binaries
        run: |
          # Create directories if they don't exist
          mkdir -p my-app/android/app/src/main/jniLibs/arm64-v8a
          mkdir -p my-app/android/app/src/main/jniLibs/armeabi-v7a
          mkdir -p my-app/android/app/src/main/jniLibs/x86_64

          # Download and extract frpc for arm64-v8a (Android ARM64)
          curl -sL "https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_android_arm64.tar.gz" -o frp_android_arm64.tar.gz
          tar -xzf frp_android_arm64.tar.gz
          cp "frp_${FRP_VERSION}_android_arm64/frpc" my-app/android/app/src/main/jniLibs/arm64-v8a/libfrpc.so
          rm -rf frp_android_arm64.tar.gz "frp_${FRP_VERSION}_android_arm64"

          # Download and extract frpc for armeabi-v7a (Linux ARM 32-bit)
          curl -sL "https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_arm.tar.gz" -o frp_linux_arm.tar.gz
          tar -xzf frp_linux_arm.tar.gz
          cp "frp_${FRP_VERSION}_linux_arm/frpc" my-app/android/app/src/main/jniLibs/armeabi-v7a/libfrpc.so
          rm -rf frp_linux_arm.tar.gz "frp_${FRP_VERSION}_linux_arm"

          # Download and extract frpc for x86_64 (Linux x86_64)
          curl -sL "https://github.com/fatedier/frp/releases/download/v${FRP_VERSION}/frp_${FRP_VERSION}_linux_amd64.tar.gz" -o frp_linux_amd64.tar.gz
          tar -xzf frp_linux_amd64.tar.gz
          cp "frp_${FRP_VERSION}_linux_amd64/frpc" my-app/android/app/src/main/jniLibs/x86_64/libfrpc.so
          rm -rf frp_linux_amd64.tar.gz "frp_${FRP_VERSION}_linux_amd64"

          # Verify files were copied
          ls -la my-app/android/app/src/main/jniLibs/*/

      - name: Build frontend
        working-directory: my-app
        run: npm run build

      - name: Sync Capacitor
        working-directory: my-app
        run: npx cap sync android

      - name: Build Android APK
        working-directory: my-app/android
        run: |
          chmod +x ./gradlew
          ./gradlew assembleRelease

      - name: Upload APK artifacts
        uses: actions/upload-artifact@v4
        with:
          name: apk-release
          path: my-app/android/app/build/outputs/apk/release/*.apk
          if-no-files-found: error
